<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner.js Example</title>
    <link rel="stylesheet" href="scanner.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .image-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background: white;
        }
        .image-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .image-info {
            padding: 10px;
            font-size: 12px;
            color: #666;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scanner.js Document Scanner Example</h1>

        <div id="status" class="status info">Initializing scanner...</div>

        <div class="controls">
            <button id="scanBtn" onclick="startScan()" disabled>Scan Document</button>
            <button id="listBtn" onclick="listScanners()" disabled>List Scanners</button>
            <button id="testBtn" onclick="testConnection()">Test Connection</button>
        </div>

        <div id="log" class="log"></div>

        <div id="imageContainer" class="image-grid" style="display: none;">
            <h3>Scanned Images:</h3>
        </div>
    </div>

    <script src="config-example.js"></script>
    <script src="scanner.js"></script>
    <script>
        let isReady = false;

        // Configure scanner
        window.scannerjs_config = {
            log_level: 0,  // Enable debug logging
            java_applet_enabled: false,  // Use WebSocket method
            scan_app_enabled: true,
            eager_init: true
        };

        // Set up event listener
        scannerjs.event_listener = function(event, data) {
            log('Event: ' + event + ' - ' + JSON.stringify(data));

            switch(event) {
                case 'loaded':
                    log('Scanner.js library loaded successfully');
                    break;
                case 'ready':
                    log('Scanner is ready to use!');
                    updateStatus('ready', 'Scanner ready - Click "Scan Document" to start');
                    isReady = true;
                    enableButtons();
                    break;
                case 'disconnected':
                    log('Scanner disconnected');
                    updateStatus('error', 'Scanner disconnected - Please check your setup');
                    isReady = false;
                    disableButtons();
                    break;
                case 'failed-to-connect':
                    log('Failed to connect to scanner service');
                    updateStatus('error', 'Cannot connect to scanner service. Please install the scan application.');
                    break;
                case 'failed-to-connect-final':
                    log('Final connection attempt failed');
                    updateStatus('error', 'Scanner setup required. Please install the scan application from the setup dialog.');
                    break;
            }
        };

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += '[' + timestamp + '] ' + message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + type;
            statusDiv.textContent = message;
        }

        function enableButtons() {
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('listBtn').disabled = false;
            document.getElementById('testBtn').disabled = false;
        }

        function disableButtons() {
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('listBtn').disabled = true;
            document.getElementById('testBtn').disabled = true;
        }

        // Enable buttons after a short delay to ensure initialization
        setTimeout(function() {
            if (!isReady) {
                log('Forcing button enable for testing...');
                enableButtons();
            }
        }, 3000);

        function startScan() {
            if (!isReady) {
                log('Scanner not ready yet');
                return;
            }

            log('Starting scan...');

            // Basic scan configuration
            const scanConfig = {
                resolution: 200,
                format: 'jpg',
                mode: 'color',
                brightness: 0,
                contrast: 0,
                pages: 1
            };

            scanner.scan(function(success, message, images) {
                log('Scan callback - Success: ' + success + ', Message: ' + message);

                if (success) {
                    log('Scan completed successfully! Processing ' + images.length + ' images...');
                    displayImages(images);
                } else {
                    log('Scan failed: ' + message);
                    updateStatus('error', 'Scan failed: ' + message);
                }
            }, JSON.stringify(scanConfig));
        }

        function listScanners() {
            if (!isReady) {
                log('Scanner not ready yet');
                return;
            }

            log('Listing available scanners...');

            scanner.listSources(function(success, message, sources) {
                log('List sources callback - Success: ' + success + ', Message: ' + message);

                if (success && sources) {
                    log('Found ' + sources.length + ' scanner(s):');
                    sources.forEach(function(source, index) {
                        log((index + 1) + '. ' + source.name + ' (' + source.type + ')');
                    });
                } else {
                    log('Failed to list scanners: ' + message);
                }
            });
        }

        function testConnection() {
            log('Testing scanner connection...');

            scanner.getSystemInfo(function(success, message, info) {
                log('System info callback - Success: ' + success + ', Message: ' + message);

                if (success) {
                    log('System info retrieved successfully');
                    log('Scanner service is running properly');
                    updateStatus('ready', 'Scanner service is running');
                } else {
                    log('Cannot retrieve system info: ' + message);
                    updateStatus('error', 'Scanner service not available');
                }
            });
        }

        function displayImages(images) {
            const container = document.getElementById('imageContainer');
            container.innerHTML = '<h3>Scanned Images:</h3>';
            container.style.display = 'block';

            if (images && images.length > 0) {
                images.forEach(function(image, index) {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'image-item';

                    const img = document.createElement('img');
                    img.src = image.src;
                    img.alt = 'Scanned page ' + (index + 1);

                    const info = document.createElement('div');
                    info.className = 'image-info';
                    info.innerHTML = `
                        Page ${index + 1}<br>
                        Size: ${image.getWidth()} Ã— ${image.getHeight()} pixels<br>
                        Resolution: ${image.getResolution()} DPI<br>
                        Color: ${image.isColor() ? 'Color' : image.isGray() ? 'Grayscale' : 'B&W'}
                    `;

                    imageDiv.appendChild(img);
                    imageDiv.appendChild(info);
                    container.appendChild(imageDiv);
                });

                updateStatus('ready', 'Scan completed - ' + images.length + ' page(s) scanned');
            } else {
                container.innerHTML += '<p>No images were returned from the scan.</p>';
            }
        }

        // Initialize on page load
        log('Page loaded, initializing scanner...');
    </script>
</body>
</html>
